<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>탈래말래 - 통합 대시보드</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script src="nav.js"></script>

  <script type="text/javascript"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f37807b77cb80bec5b35db61d2ad7dba&libraries=services&autoload=false"></script>

  <script>
    const currentUser = JSON.parse(localStorage.getItem("tm_user"));
    // 로그인 정보가 없으면 로그인 페이지로 리다이렉트
    if (!currentUser) {
      alert("로그인이 필요합니다.");
      location.href = "login.html";
    }
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap");

    :root {
      --tm-primary: #4f46e5;
      --tm-mint: #10b981;
      --tm-dark: #1e1b4b;
      --nav-height: 60px;
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    body {
      font-family: "Pretendard", sans-serif;
      overflow: hidden;
      background-color: #f8fafc;
      overscroll-behavior: none;
      /* 스크롤 튕김 방지 */
    }

    /* === 지도 및 패널 스타일 === */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
    }

    /* 글래스모피즘 효과 (반투명 배경) */
    .glass-panel {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    /* === 모바일 네비게이션 === */
    #mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: calc(var(--nav-height) + var(--safe-bottom));
      background: white;
      border-top: 1px solid #e2e8f0;
      z-index: 90;
      padding-bottom: var(--safe-bottom);
      justify-content: space-around;
      align-items: center;
    }

    .mobile-nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #94a3b8;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .mobile-nav-item.active {
      color: var(--tm-primary);
    }

    /* === 더보기 메뉴 오버레이 === */
    #more-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 95;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    #more-menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    #more-menu-content {
      position: absolute;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 10px);
      right: 10px;
      width: 200px;
      background: white;
      border-radius: 1.5rem;
      padding: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    #more-menu-overlay.active #more-menu-content {
      transform: translateY(0);
    }

    /* === 반응형 사이드 패널 (드래그 가능) === */
    #side-panel-wrapper {
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
      z-index: 50;
    }

    /* 맵 컨트롤 (줌, 위치, 프로필) */
    #map-controls {
      z-index: 10;
      transition: opacity 0.2s;
    }

    /* 패널이 열리면 맵 컨트롤을 뒤로 숨김 */
    body.panel-open #map-controls {
      z-index: 0 !important;
      opacity: 0.3;
      pointer-events: none;
    }

    /* 상세 패널 트랜지션 */
    #detailPanel {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
    }

    /* 리스트 아이템 등장 애니메이션 */
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* === 모바일 전용 스타일 (768px 이하) === */
    @media (max-width: 768px) {
      #navbar-container {
        display: none !important;
      }

      #mobile-nav {
        display: flex !important;
      }

      /* 사이드 패널 -> 하단 바텀시트 변환 */
      #side-panel-wrapper {
        position: fixed;
        left: 0;
        right: 0;
        bottom: calc(var(--nav-height) + var(--safe-bottom));
        width: 100% !important;
        height: 80vh;
        margin-left: 0 !important;
        border-radius: 1.5rem 1.5rem 0 0 !important;
        transform: translateY(calc(100% - 150px));
        touch-action: none;
      }

      .drag-handle-area {
        width: 100%;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .drag-handle-bar {
        width: 40px;
        height: 5px;
        background-color: #cbd5e1;
        border-radius: 99px;
      }

      /* 상세 패널 모바일 스타일 */
      #detailPanel.active {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100% !important;
        height: 90vh !important;
        margin-left: 0 !important;
        border-radius: 2rem 2rem 0 0 !important;
        z-index: 96;
        transform: translateY(0);
        opacity: 1 !important;
      }

      #detailPanel {
        transform: translateY(100%);
        width: 100% !important;
      }
    }

    /* === PC 전용 스타일 (769px 이상) === */
    @media (min-width: 769px) {
      #detailPanel {
        transform: translateX(-20px);
        width: 0;
        pointer-events: none;
      }

      #detailPanel.active {
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
        width: 400px;
        margin-left: 1rem;
      }

      #mobile-nav {
        display: none !important;
      }
    }

    /* 모집 생성 모달 */
    #createPanel {
      transition: all 0.3s;
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
      z-index: 100;
    }

    #createPanel.active {
      opacity: 1;
      pointer-events: auto;
      visibility: visible;
    }

    /* 성공 모달 */
    #successModal {
      transition: opacity 0.3s ease;
    }

    #successModal.show {
      opacity: 1;
      visibility: visible;
    }

    #successModal .modal-card {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform: scale(0.9);
    }

    #successModal.show .modal-card {
      transform: scale(1);
    }

    /* 마커 커스텀 스타일 */
    .user-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      animation: pulse 2s infinite;
    }

    .my-marker {
      background-color: #4f46e5;
      width: 24px;
      height: 24px;
      z-index: 100;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.4);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 8px rgba(0, 0, 0, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
      }
    }

    /* 모바일용 모집 플로팅 버튼 */
    .fab-recruit {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 170px);
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #1e1b4b;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(30, 27, 75, 0.3);
      z-index: 60;
      transition: transform 0.2s;
    }

    .fab-recruit:active {
      transform: scale(0.95);
    }

    body.panel-open .fab-recruit {
      transform: scale(0);
    }

    /* 토스트 알림 */
    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1e1b4b;
      color: white;
      padding: 1rem 2rem;
      border-radius: 1rem;
      z-index: 1000;
      transition: transform 0.3s ease;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    #toast.show {
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="toast">메시지 내용</div>

  <button onclick="openCreate()" class="fab-recruit md:hidden">
    <i data-lucide="plus" class="w-6 h-6"></i>
  </button>

  <div id="main-layout" class="absolute inset-0 z-10 flex p-4 w-full h-full pointer-events-none">
    <div id="navbar-container" class="w-20 h-full shrink-0 rounded-[2.5rem] pointer-events-auto"></div>

    <div id="side-panel-wrapper"
      class="glass-panel w-[380px] h-full rounded-[2.5rem] flex flex-col overflow-hidden ml-4 shrink-0">

      <div class="drag-handle-area md:hidden" id="dragHandle" onclick="togglePanelState()">
        <div class="drag-handle-bar"></div>
      </div>

      <div class="p-6 md:p-8 border-b border-slate-100 shrink-0">
        <h1 class="text-xl md:text-2xl font-bold text-slate-900 tracking-tight mb-4 flex justify-between items-center">
          <span>탈래말래</span>
          <span id="connection-status"
            class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full">Offline</span>
        </h1>
        <div class="space-y-3">
          <div class="relative group">
            <i data-lucide="map-pin" class="absolute left-4 top-4 w-4 h-4 text-emerald-500"></i>
            <input type="text" id="startInput" placeholder="출발지" value="" onfocus="expandPanel()"
              class="w-full pl-11 pr-4 py-3.5 bg-slate-50/50 rounded-2xl text-sm border border-transparent focus:bg-white focus:border-indigo-100 transition-all outline-none" />
          </div>
          <div class="relative group">
            <i data-lucide="navigation" class="absolute left-4 top-4 w-4 h-4 text-rose-500"></i>
            <input type="text" id="destInput" placeholder="목적지" value="" onfocus="expandPanel()"
              class="w-full pl-11 pr-4 py-3.5 bg-slate-50/50 rounded-2xl text-sm border border-transparent focus:bg-white focus:border-indigo-100 transition-all outline-none" />
          </div>
          <button onclick="handleSearch(); expandPanel();"
            class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-sm shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95 flex items-center justify-center gap-2 mt-2 group">
            <i data-lucide="list-filter" class="w-4 h-4 transition-transform group-hover:scale-110"></i>
            조건에 맞는 모집 찾기
          </button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-4" id="recruitList">
        <h3 class="font-bold text-slate-800 text-lg px-1 mb-2">로딩 중...</h3>
      </div>
    </div>

    <div id="detailPanel" class="glass-panel h-full rounded-[2.5rem] flex flex-col pointer-events-auto overflow-hidden">
      <div id="detailContent" class="flex flex-col h-full"></div>
    </div>
  </div>

  <div id="bottomBar"
    class="hidden md:flex absolute bottom-8 left-[500px] right-8 z-10 transition-all duration-500 justify-end pointer-events-auto">
    <div
      class="glass-panel p-6 rounded-[2.5rem] flex items-center justify-between gap-12 pointer-events-auto border border-white/50 shadow-xl w-full max-w-4xl">
      <div class="flex-1 flex items-center gap-10 pl-4">
        <div class="flex flex-col">
          <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">경로 정보</span>
          <div class="flex items-center gap-2 font-bold text-slate-800">
            <i data-lucide="navigation-2" class="w-4 h-4 text-indigo-600"></i>
            <span id="displayRoute" class="text-slate-400">경로 미지정</span>
          </div>
        </div>
        <div class="h-8 w-px bg-slate-100"></div>
        <div class="flex flex-col">
          <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 text-center">인원</span>
          <span id="displayCount" class="font-bold text-slate-800 text-center">-명</span>
        </div>
      </div>
      <button onclick="openCreate()"
        class="bg-slate-900 hover:bg-indigo-600 text-white px-10 py-5 rounded-2xl font-bold flex items-center gap-3 transition-all active:scale-95 shadow-xl group">
        <span>모집 시작</span>
        <i data-lucide="rocket"
          class="w-5 h-5 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
      </button>
    </div>
  </div>

  <div id="mobile-nav">
    <div class="mobile-nav-item active" onclick="location.reload()">
      <i data-lucide="home" class="w-6 h-6 mb-1"></i>
      <span>홈</span>
    </div>
    <div class="mobile-nav-item" onclick="location.href='chat.html'">
      <i data-lucide="message-circle" class="w-6 h-6 mb-1"></i>
      <span>채팅</span>
    </div>
    <div class="mobile-nav-item" onclick="location.href='mypage.html'">
      <i data-lucide="user" class="w-6 h-6 mb-1"></i>
      <span>마이</span>
    </div>
    <div class="mobile-nav-item" onclick="toggleMoreMenu()">
      <i data-lucide="menu" class="w-6 h-6 mb-1"></i>
      <span>더보기</span>
    </div>
  </div>

  <div id="more-menu-overlay" onclick="toggleMoreMenu()">
    <div id="more-menu-content">
      <ul class="space-y-1">
        <li onclick="location.href='notifications.html'"
          class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-xl cursor-pointer">
          <i data-lucide="bell" class="w-5 h-5 text-slate-500"></i>
          <span class="text-sm font-bold text-slate-700">알림</span>
        </li>
        <li onclick="location.href='notice.html'"
          class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-xl cursor-pointer">
          <i data-lucide="megaphone" class="w-5 h-5 text-slate-500"></i>
          <span class="text-sm font-bold text-slate-700">공지사항</span>
        </li>
        <li onclick="location.href='setting.html'"
          class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-xl cursor-pointer">
          <i data-lucide="settings" class="w-5 h-5 text-slate-500"></i>
          <span class="text-sm font-bold text-slate-700">설정</span>
        </li>
        <li onclick="handleLogout()"
          class="flex items-center gap-3 p-3 hover:bg-rose-50 rounded-xl cursor-pointer text-rose-600">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          <span class="text-sm font-bold">로그아웃</span>
        </li>
      </ul>
    </div>
  </div>

  <div id="map-controls" class="absolute top-4 right-4 flex flex-col gap-3 pointer-events-auto">
    <div onclick="location.href='myPage.html'"
      class="glass-panel p-2.5 rounded-2xl flex items-center gap-3 pr-5 cursor-pointer hover:shadow-md hover:border-indigo-100 transition-all active:scale-95">
      <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white font-bold">
        판교
      </div>
      <div class="hidden md:flex flex-col">
        <span class="text-sm font-bold text-slate-900" id="user-nickname">판교동승왕</span>
        <span class="text-[11px] text-emerald-600 font-bold">37.5°C</span>
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <button onclick="zoomIn()"
        class="glass-panel w-12 h-12 rounded-2xl flex items-center justify-center hover:text-indigo-600">
        <i data-lucide="plus" class="w-5 h-5"></i>
      </button>
      <button onclick="zoomOut()"
        class="glass-panel w-12 h-12 rounded-2xl flex items-center justify-center hover:text-indigo-600">
        <i data-lucide="minus" class="w-5 h-5"></i>
      </button>
      <button onclick="panToCurrent()"
        class="glass-panel w-12 h-12 rounded-2xl bg-indigo-600 text-white flex items-center justify-center mt-2 shadow-lg shadow-indigo-100">
        <i data-lucide="locate-fixed" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <div id="createPanel" class="fixed inset-0 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
    <div
      class="modal-content glass-panel w-full max-w-2xl rounded-[2rem] overflow-hidden pointer-events-auto shadow-2xl flex flex-col max-h-[85vh] bg-white">
      <div class="p-6 border-b border-slate-100 flex items-center justify-between">
        <h2 class="text-xl font-bold text-slate-900">동승 모집하기</h2>
        <button onclick="closeCreate()" class="p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="x"
            class="w-5 h-5"></i></button>
      </div>
      <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-6">
        <div class="grid grid-cols-2 gap-3">
          <div
            class="bg-slate-50 p-4 rounded-2xl border border-slate-100 focus-within:border-indigo-300 focus-within:bg-white transition-all">
            <span class="text-[10px] text-emerald-500 font-bold block mb-1">출발지</span>
            <input type="text" id="createStart"
              class="w-full bg-transparent font-bold text-slate-800 outline-none placeholder-slate-400"
              placeholder="출발지 입력">
          </div>
          <div
            class="bg-slate-50 p-4 rounded-2xl border border-slate-100 focus-within:border-indigo-300 focus-within:bg-white transition-all">
            <span class="text-[10px] text-rose-500 font-bold block mb-1">목적지</span>
            <input type="text" id="createDest"
              class="w-full bg-transparent font-bold text-slate-800 outline-none placeholder-slate-400"
              placeholder="목적지 입력">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-2">
            <label class="text-xs font-bold text-slate-400">출발 시간</label>
            <select class="w-full pl-4 py-4 pr-10 bg-slate-50 rounded-2xl text-sm font-bold outline-none">
              <option value="Now">지금 바로</option>
              <option value="10분 후">10분 후</option>
              <option value="20분 후">20분 후</option>
            </select>
          </div>

          <div class="space-y-2">
            <label class="text-xs font-bold text-slate-400">모집 인원</label>
            <div class="flex items-center justify-between w-full p-2 bg-slate-50 rounded-2xl">
              <button onclick="updateMemberCount(-1)"
                class="w-10 h-10 bg-white rounded-xl shadow-sm text-slate-500 hover:text-indigo-600"><i
                  data-lucide="minus" class="w-4 h-4 mx-auto"></i></button>
              <span id="createMaxMember" class="font-bold text-slate-800">4명</span>
              <button onclick="updateMemberCount(1)"
                class="w-10 h-10 bg-white rounded-xl shadow-sm text-slate-500 hover:text-indigo-600"><i
                  data-lucide="plus" class="w-4 h-4 mx-auto"></i></button>
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-400">태그 (선택)</label>
          <input type="text" id="createTags"
            class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none placeholder-slate-400"
            placeholder="예: #비흡연 #여성전용">
        </div>

        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-400">하고 싶은 말</label>
          <textarea class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none resize-none h-20"
            placeholder="예: 짐이 조금 있어요"></textarea>
        </div>

        <button onclick="handleFinishCreate()"
          class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200">
          모집 시작하기
        </button>
      </div>
    </div>
  </div>

  <div id="successModal"
    class="fixed inset-0 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm z-[110] hidden opacity-0">
    <div class="modal-card bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl pointer-events-auto">
      <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
        <i data-lucide="check" class="w-8 h-8"></i>
      </div>
      <h3 class="text-xl font-bold text-slate-900 mb-2">모집을 시작했습니다!</h3>
      <p class="text-slate-500 text-sm mb-6">주변 사용자들에게 알림을 보냈습니다.</p>
      <button onclick="closeSuccessModal()"
        class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
        확인
      </button>
    </div>
  </div>

  <script>
    // === [1. 전역 변수 설정 (var -> let/const 변경됨)] ===
    let map; // 카카오맵 인스턴스
    let ws; // 웹소켓 인스턴스
    let myLat = 37.498095, myLng = 127.02761; // 내 현재 위치 (초기값: 강남역)
    let myMarker = null; // 내 위치 마커
    let otherMarkers = {}; // 다른 사용자들의 마커 목록 (id: marker)

    // 모바일 드로어 관련 변수
    const panel = document.getElementById('side-panel-wrapper');
    const handle = document.getElementById('dragHandle');
    let isMobile = () => window.innerWidth <= 768; // 모바일 여부 확인 함수
    let panelState = 'collapsed'; // 패널 상태 (collapsed | expanded)
    let startY = 0, currentY = 0, isDragging = false; // 드래그 이벤트용 변수

    let recruitmentData = []; // 모집 정보 리스트 데이터
    let currentDetailId = null; // 현재 보고 있는 상세 정보 ID
    let currentMaxMember = 4; // 모집 생성 시 최대 인원

    // === [2. 초기화 로직] ===
    window.onload = () => {
      // 닉네임 표시
      if (currentUser.nickname) {
        const nickEl = document.getElementById("user-nickname");
        if (nickEl) nickEl.innerText = currentUser.nickname;
      }

      // 데스크탑 네비게이션 로드
      if (typeof loadNavbar === "function") loadNavbar("nav-home");

      // 초기 데이터 로드 (Axios)
      fetchRecruits();

      // 카카오맵 및 위치 로직 시작
      if (window.kakao && window.kakao.maps) {
        kakao.maps.load(() => {
          const mapContainer = document.getElementById("map");
          const mapOption = { center: new kakao.maps.LatLng(myLat, myLng), level: 3 };
          map = new kakao.maps.Map(mapContainer, mapOption);

          initGeolocation(); // GPS 시작
          connectWebSocket(); // 소켓 연결
          initMapClickEvent(); // 지도 클릭 이벤트
        });
      }
    };

    // === [3. 인증 및 사용자 관리] ===
    function handleLogout() {
      if (confirm("로그아웃 하시겠습니까?")) {
        localStorage.removeItem("tm_user");
        location.href = "login.html";
      }
    }

    // === [4. UI 제어 로직 (패널, 모달, 알림)] ===

    // 모바일 패널 토글 (터치 시)
    function togglePanelState() {
      if (!isMobile()) return;
      if (panelState === 'collapsed') {
        expandPanel();
      } else {
        collapsePanel();
      }
    }

    // 패널 확장 (위로 올라옴)
    function expandPanel() {
      if (!isMobile()) return;
      panel.style.transform = 'translateY(0)';
      panelState = 'expanded';
      document.body.classList.add('panel-open');
    }

    // 패널 축소 (아래로 내려감)
    function collapsePanel() {
      if (!isMobile()) return;
      panel.style.transform = 'translateY(calc(100% - 150px))';
      panelState = 'collapsed';
      document.body.classList.remove('panel-open');
    }

    // 드래그 이벤트 리스너들
    handle.addEventListener('touchstart', (e) => {
      if (!isMobile()) return;
      startY = e.touches[0].clientY;
      isDragging = true;
      panel.style.transition = 'none'; // 드래그 중엔 애니메이션 끔
    });
    handle.addEventListener('touchmove', (e) => {
      if (!isDragging || !isMobile()) return;
      currentY = e.touches[0].clientY;
      const deltaY = currentY - startY;
      // 위로 드래그
      if (deltaY < -50 && panelState === 'collapsed') {
        expandPanel(); isDragging = false;
      }
      // 아래로 드래그
      if (deltaY > 50 && panelState === 'expanded') {
        collapsePanel(); isDragging = false;
      }
    });
    handle.addEventListener('touchend', () => {
      isDragging = false;
      panel.style.transition = 'transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1)';
    });

    // 화면 크기 변경 감지 (버그 수정용)
    window.addEventListener('resize', () => {
      // PC 화면으로 커지면 모바일 스타일 초기화
      if (window.innerWidth > 768) {
        panel.style.transform = '';
        panel.style.transition = '';
        panel.classList.remove('collapsed');
        document.body.classList.remove('panel-open');
        panelState = 'collapsed';
      }
    });

    // 지도 클릭 시 패널 닫기
    function initMapClickEvent() {
      if (window.kakao && window.kakao.maps && map) {
        kakao.maps.event.addListener(map, 'click', function () {
          collapsePanel();
        });
      }
    }

    // 더보기 메뉴 토글
    function toggleMoreMenu() {
      document.getElementById('more-menu-overlay').classList.toggle('active');
    }

    // 성공 모달 표시
    function showSuccessModal() {
      const modal = document.getElementById('successModal');
      modal.classList.remove('hidden');
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);
      lucide.createIcons();
    }

    // 성공 모달 닫기
    function closeSuccessModal() {
      const modal = document.getElementById('successModal');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // 토스트 알림 표시
    function showNotification(msg) {
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.innerText = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // === [5. 데이터 및 모집 로직] ===

    // 서버에서 모집 리스트 가져오기
    async function fetchRecruits() {
      try {
        const response = await axios.get('/recruits');
        recruitmentData = response.data;
        renderRecruitList(recruitmentData);
      } catch (error) {
        console.error("데이터 로드 실패:", error);
        renderRecruitList([]);
      }
    }

    // 리스트 렌더링
    function renderRecruitList(list) {
      const container = document.getElementById("recruitList");
      if (!container) return;
      container.innerHTML = `<h3 class="font-bold text-slate-800 text-lg px-1 mb-2">실시간 모집 (${list.length})</h3>`;

      if (list.length === 0) {
        container.innerHTML += `<div class="py-10 text-center text-slate-400 text-sm">아직 모집 중인 글이 없어요.</div>`;
        return;
      }

      list.forEach((item) => {
        const card = document.createElement("div");
        card.onclick = () => openDetail(item.id);
        card.className = "bg-white p-5 rounded-3xl border border-slate-100 shadow-sm mb-4 cursor-pointer hover:bg-slate-50 active:bg-slate-100 transition-colors animate-fade-in";
        card.innerHTML = `
          <div class="flex justify-between mb-2 pointer-events-none">
            <span class="bg-emerald-50 text-emerald-600 text-[10px] font-bold px-2 py-1 rounded">${item.time}</span>
            <span class="text-[10px] text-slate-400">방금</span>
          </div>
          <p class="font-bold text-slate-800 pointer-events-none">${item.start} → ${item.dest}</p>
        `;
        container.appendChild(card);
      });
      lucide.createIcons();
    }

    // 상세 정보 패널 열기
    function openDetail(id) {
      const panel = document.getElementById("detailPanel");
      if (currentDetailId === id && panel.classList.contains("active")) {
        closeDetail(); return;
      }
      currentDetailId = id;
      const item = recruitmentData.find((d) => d.id === id);
      const content = document.getElementById("detailContent");

      panel.classList.add("active");

      // 인원수 및 마감 여부 체크
      const current = item.cur || 1;
      const max = item.max || 4;
      const isFull = current >= max;

      const btnClass = isFull
        ? "bg-slate-300 text-slate-500 cursor-not-allowed"
        : "bg-slate-900 hover:bg-indigo-600 text-white shadow-xl";

      const btnText = isFull ? "모집이 마감되었습니다" : "동승 채팅방 입장";
      const btnAction = isFull ? "" : `onclick="joinRecruit(${item.id})"`;

      content.innerHTML = `
        <div class="p-8 border-b border-slate-100 flex items-center justify-between">
          <h3 class="font-bold text-slate-900 text-lg">상세 정보</h3>
          <button onclick="closeDetail()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scroll p-8 space-y-8">
          <div>
            <div class="flex items-center justify-between mb-4">
               <span class="text-[11px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg inline-block">${item.time} 출발</span>
               <span class="text-sm font-bold text-slate-500">
                  <span class="${isFull ? 'text-rose-500' : 'text-indigo-600'}">${current}</span> / ${max}명
               </span>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 leading-tight">${item.start} → ${item.dest}</h2>
          </div>
          <p class="text-[14px] text-slate-600 leading-relaxed bg-slate-50 p-5 rounded-3xl">${item.desc}</p>
          <div class="flex flex-wrap gap-2">${(item.tags || []).map(tag => `<span class="text-[11px] font-bold border border-slate-100 px-4 py-2 rounded-xl bg-white shadow-sm">${tag}</span>`).join("")}</div>
        </div>
        <div class="p-8 bg-slate-50/50 border-t border-slate-100 pb-28 md:pb-8">
           <button ${btnAction} class="w-full font-bold py-5 rounded-2xl transition-all ${btnClass}">
             ${btnText}
           </button>
        </div>`;
      lucide.createIcons();
    }

    function closeDetail() {
      document.getElementById("detailPanel").classList.remove("active");
      currentDetailId = null;
    }

    // 검색 기능
    function handleSearch() {
      const startVal = document.getElementById("startInput").value.trim();
      const destVal = document.getElementById("destInput").value.trim();

      // 하단 경로 정보 업데이트
      const routeEl = document.getElementById("displayRoute");
      if (startVal && destVal) {
        routeEl.innerText = `${startVal} → ${destVal}`;
        routeEl.classList.remove("text-slate-400");
        routeEl.classList.add("text-slate-800");
      } else {
        routeEl.innerText = "경로 미지정";
        routeEl.classList.add("text-slate-400");
        routeEl.classList.remove("text-slate-800");
      }

      const filtered = recruitmentData.filter(item =>
        (!startVal || item.start.includes(startVal)) &&
        (!destVal || item.dest.includes(destVal))
      );
      renderRecruitList(filtered);
    }

    // 인원수 변경 로직 (+/- 버튼)
    function updateMemberCount(change) {
      currentMaxMember += change;
      if (currentMaxMember < 2) currentMaxMember = 2;
      if (currentMaxMember > 10) currentMaxMember = 10;
      document.getElementById("createMaxMember").innerText = `${currentMaxMember}명`;
    }

    // 모집 생성 모달 열기 (값 초기화)
    function openCreate() {
      document.getElementById("createStart").value = "";
      document.getElementById("createDest").value = "";
      document.getElementById("createTags").value = "";
      document.querySelector("#createPanel textarea").value = "";
      currentMaxMember = 4;
      document.getElementById("createMaxMember").innerText = "4명";
      document.getElementById("createPanel").classList.add("active");
    }

    function closeCreate() { document.getElementById("createPanel").classList.remove("active"); }

    // 모집 생성 완료 처리
    function handleFinishCreate() {
      const start = document.getElementById("createStart").value;
      const dest = document.getElementById("createDest").value;
      const time = document.querySelector("#createPanel select").value;
      const desc = document.querySelector("#createPanel textarea").value || "같이 가요!";
      const tagInput = document.getElementById("createTags").value;

      // 태그 파싱
      const tags = tagInput.trim().split(/\s+/).filter(t => t).map(t => t.startsWith('#') ? t : '#' + t);

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'createRecruit',
          payload: { start, dest, time, desc, tags, max: currentMaxMember }
        }));

        closeCreate();
        showSuccessModal();
      } else {
        alert("서버 연결 상태를 확인해주세요.");
      }
    }

    // 채팅방 입장 처리
    function joinRecruit(id) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'joinRecruit',
          recruitId: id
        }));
        location.href = 'chat.html'; // 페이지 이동
      } else {
        alert("서버와 연결되어 있지 않습니다.\n잠시 후 다시 시도해주세요.");
        connectWebSocket(); // 재연결 시도
      }
    }

    // === [6. 지도 및 위치 관련 로직] ===

    // GPS 시작
    function initGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          myLat = pos.coords.latitude;
          myLng = pos.coords.longitude;
          updateMyMarker();
          sendLocation();
        }, null, { enableHighAccuracy: false });
      }
    }

    // 내 위치 마커 업데이트
    function updateMyMarker() {
      if (!map) return;
      const loc = new kakao.maps.LatLng(myLat, myLng);
      if (!myMarker) {
        myMarker = new kakao.maps.CustomOverlay({
          map: map, position: loc,
          content: '<div class="user-marker my-marker"></div>',
          yAnchor: 0.5, zIndex: 100
        });
        map.panTo(loc);
      } else {
        myMarker.setPosition(loc);
      }
    }

    // 웹소켓 연결
    function connectWebSocket() {
      const wsUrl = "wss://www.jdhtest.kro.kr/ws?userId=" + encodeURIComponent(currentUser.id);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        document.getElementById('connection-status').innerText = "Online";
        document.getElementById('connection-status').className = "text-[10px] bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'updateUsers') {
          updateOtherUsers(data.users);
        }
        else if (data.type === 'newRecruit') {
          // 새 모집글 수신
          recruitmentData.unshift(data.recruit);
          renderRecruitList(recruitmentData);
          showNotification(`새 모집: ${data.recruit.start} → ${data.recruit.dest}`);
        }
        else if (data.type === 'updateRecruit') {
          // 모집 정보 업데이트 (인원수 등)
          const index = recruitmentData.findIndex(r => r.id === data.recruit.id);
          if (index !== -1) {
            recruitmentData[index] = data.recruit;
            if (currentDetailId === data.recruit.id) {
              openDetail(data.recruit.id);
            }
          }
        }
      };

      ws.onclose = () => {
        document.getElementById('connection-status').innerText = "Offline";
        document.getElementById('connection-status').className = "text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full";
      };
    }

    // 내 위치 전송
    function sendLocation() {
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'location', lat: myLat, lng: myLng }));
    }

    // 주변 사용자 마커 업데이트
    function updateOtherUsers(users) {
      if (!map) return;
      const activeIds = new Set();
      let nearbyCount = 0;

      users.forEach(user => {
        if (user.id === currentUser.id) return; // 나 자신 제외

        const dist = getDistance(myLat, myLng, user.lat, user.lng);
        // 10000km 이내 표시 (테스트용 전체 공개)
        if (dist <= 10000) {
          activeIds.add(user.id);
          nearbyCount++;
          const loc = new kakao.maps.LatLng(user.lat, user.lng);

          if (otherMarkers[user.id]) {
            otherMarkers[user.id].setPosition(loc);
          } else {
            const content = `<div class="user-marker" style="background-color: ${user.color}"></div>`;
            otherMarkers[user.id] = new kakao.maps.CustomOverlay({
              map: map,
              position: loc,
              content: content,
              yAnchor: 0.5
            });
          }
        }
      });

      // 나간 유저 마커 삭제
      for (const id in otherMarkers) {
        if (!activeIds.has(id)) {
          otherMarkers[id].setMap(null);
          delete otherMarkers[id];
        }
      }

      const countEl = document.getElementById('nearby-count-mobile');
      if (countEl) countEl.innerText = nearbyCount;
    }

    // 거리 계산 함수 (Haversine Formula)
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // 줌 및 이동 함수
    function zoomIn() { if (map) map.setLevel(map.getLevel() - 1); }
    function zoomOut() { if (map) map.setLevel(map.getLevel() + 1); }
    function panToCurrent() { if (map) map.panTo(new kakao.maps.LatLng(myLat, myLng)); }
  </script>
</body>

</html>